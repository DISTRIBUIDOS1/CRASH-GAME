<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sala de Apuestas</title>
</head>
<body>
  <h1>Sala de Apuestas</h1>
  <div>
    <input id="user" placeholder="Nombre" />
    <input id="amount" placeholder="Monto" type="number" />
    <button id="betBtn">Apostar</button>
  </div>
  <div id="status">Desconectado</div>
  <ul id="bets"></ul>

<script>
const status = document.getElementById('status');
const bets = document.getElementById('bets');
const userEl = document.getElementById('user');
const amountEl = document.getElementById('amount');
const betBtn = document.getElementById('betBtn');

const API_BASE = ''; // si sirves frontend desde nginx usa la misma host
let ws;
let retryDelay = 1000;

function connect() {
  const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(protocol + '://' + location.host + '/');

  ws.onopen = () => {
    status.innerText = 'Conectado';
    retryDelay = 1000;
  };
  ws.onmessage = (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'new_bet') addBet(msg.data);
    } catch (e) { console.log(e); }
  };
  ws.onclose = () => {
    status.innerText = 'Desconectado. Reintentando...';
    setTimeout(() => {
      // backoff exponencial con tope
      retryDelay = Math.min(10000, retryDelay * 1.8);
      connect();
    }, retryDelay);
  };
  ws.onerror = (e) => {
    console.error('WS error', e);
    ws.close();
  };
}

function addBet(bet) {
  const li = document.createElement('li');
  li.innerText = `${bet.user_name} apostó ${bet.amount} — ${new Date(bet.created_at).toLocaleTimeString()}`;
  bets.prepend(li);
}

betBtn.onclick = async () => {
  const user = userEl.value || 'anon';
  const amount = Number(amountEl.value) || 0;
  try {
    const r = await fetch('/bets', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ user, amount })
    });
    if (!r.ok) throw new Error('error al apostar');
    const bet = await r.json();
    addBet(bet); 
  } catch (e) {
    console.error(e);
    alert('Error enviando apuesta');
  }
};

connect();
</script>
</body>
</html>
